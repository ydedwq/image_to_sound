<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аудио-визуальный преобразователь</title>
    <link rel="icon" type="image/png" href="/videos/1488165.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        canvas {
            max-width: 100%;
            border: 1px solid #ddd;
            margin: 10px 0;
            display: block;
            background-color: #000;
        }
        button, input[type="file"] {
            margin: 10px 5px 10px 0;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            font-style: italic;
            color: #666;
        }
        .audio-controls {
            margin-top: 15px;
        }
        .slider-container {
            margin: 15px 0;
        }
        label {
            display: inline-block;
            width: 150px;
        }
        .settings {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        .setting-group {
            flex: 1;
            min-width: 200px;
        }
        .progress-container {
            margin: 20px 0;
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 4px;
            display: none;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
            text-align: center;
            line-height: 20px;
            color: white;
        }
        .spectrogram-container {
            margin-top: 20px;
            display: none;
        }
        .image-resize-controls {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .dimension-display {
            font-family: monospace;
            margin-left: 10px;
        }
        .section-title {
            margin-top: 0;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        .dual-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        .frequency-legend {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            color: white;
            font-size: 12px;
        }
        .time-legend {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: black;
            font-size: 12px;
        }
        .spectrogram-wrapper {
            position: relative;
        }
    </style>
</head>
<body>
    <h1>Аудио-визуальный преобразователь</h1>
    
    <!-- Секция: Изображение → Аудио -->
    <div class="container">
        <h3 class="section-title">1. Преобразование изображения в звук</h3>
        
        <div>
            <h4>Загрузите изображение</h4>
            <input type="file" id="imageInput" accept="image/*">
            <canvas id="imageCanvas"></canvas>
            <div class="status" id="imageStatus"></div>
            
            <div class="image-resize-controls">
                <h5>Настройки размера изображения</h5>
                <div class="slider-container">
                    <label for="widthSlider">Ширина:</label>
                    <input type="range" id="widthSlider" min="100" max="2000" value="800">
                    <span class="dimension-display" id="widthValue">800</span> px
                </div>
                <div class="slider-container">
                    <label for="heightSlider">Высота:</label>
                    <input type="range" id="heightSlider" min="100" max="2000" value="400">
                    <span class="dimension-display" id="heightValue">400</span> px
                </div>
                <div class="slider-container">
                    <label for="keepAspectCheckbox">Сохранять пропорции:</label>
                    <input type="checkbox" id="keepAspectCheckbox" checked>
                </div>
                <button id="resizeImageBtn">Применить размер</button>
            </div>
            
            <div class="settings">
                <div class="setting-group">
                    <div class="slider-container">
                        <label for="durationSlider">Длительность (сек):</label>
                        <input type="range" id="durationSlider" min="1" max="20" value="5" step="0.5">
                        <span id="durationValue">5</span>
                    </div>
                    
                    <div class="slider-container">
                        <label for="pitchSlider">Тональность:</label>
                        <input type="range" id="pitchSlider" min="0.1" max="3" value="1" step="0.1">
                        <span id="pitchValue">1</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="slider-container">
                        <label for="fftSizeSlider">Детализация FFT:</label>
                        <input type="range" id="fftSizeSlider" min="9" max="14" value="12" step="1">
                        <span id="fftSizeValue">4096</span>
                    </div>
                    
                    <div class="slider-container">
                        <label for="brightnessSlider">Яркость звука:</label>
                        <input type="range" id="brightnessSlider" min="0.5" max="2" value="1" step="0.1">
                        <span id="brightnessValue">1</span>
                    </div>
                </div>
            </div>
            
            <button id="generateAudioBtn" disabled>Создать аудио из изображения</button>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="audio-controls" id="audioControls" style="display: none;">
                <audio id="audioPlayer" controls></audio>
                <button id="saveAudioBtn">Сохранить аудиофайл</button>
                <button id="showSpectrogramBtn">Показать спектрограмму</button>
            </div>
            <div class="status" id="audioStatus"></div>
            
            <div class="spectrogram-container" id="spectrogramContainer">
                <h4>Спектрограмма созданного звука</h4>
                <div class="spectrogram-wrapper">
                    <div class="frequency-legend">Частота (Гц)</div>
                    <canvas id="spectrogramCanvas"></canvas>
                    <div class="time-legend">Время (сек)</div>
                </div>
                <button id="saveSpectrogramBtn">Сохранить спектрограмму</button>
                <div class="status" id="spectrogramStatus"></div>
            </div>
        </div>
    </div>
    
    <!-- Секция: Аудио → Спектрограмма -->
    <div class="container">
        <h3 class="section-title">2. Анализ аудио и создание спектрограммы</h3>
        
        <div class="dual-column">
            <div>
                <h4>Загрузите аудиофайл</h4>
                <input type="file" id="audioFileInput" accept="audio/*">
                <div class="audio-controls">
                    <audio id="audioFilePlayer" controls></audio>
                </div>
                <div class="status" id="audioFileStatus"></div>
                <button id="analyzeAudioBtn" disabled>Анализировать аудио</button>
                <div class="progress-container" id="audioAnalysisProgress">
                    <div class="progress-bar" id="audioAnalysisBar">0%</div>
                </div>
            </div>
            <div>
                <h4>Результат анализа</h4>
                <div class="spectrogram-wrapper">
                    <div class="frequency-legend">Частота (Гц)</div>
                    <canvas id="audioSpectrogramCanvas"></canvas>
                    <div class="time-legend">Время (сек)</div>
                </div>
                <button id="saveAudioSpectrogramBtn" disabled>Сохранить спектрограмму</button>
                <div class="status" id="audioSpectrogramStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== Общие функции =====
        function setupSlider(slider, valueElement, formatter = v => v) {
            slider.addEventListener('input', () => {
                valueElement.textContent = formatter(slider.value);
            });
        }
        
        // ===== Секция: Изображение → Аудио =====
        const imageSection = {
            elements: {
                imageInput: document.getElementById('imageInput'),
                imageCanvas: document.getElementById('imageCanvas'),
                spectrogramCanvas: document.getElementById('spectrogramCanvas'),
                generateAudioBtn: document.getElementById('generateAudioBtn'),
                saveAudioBtn: document.getElementById('saveAudioBtn'),
                saveSpectrogramBtn: document.getElementById('saveSpectrogramBtn'),
                showSpectrogramBtn: document.getElementById('showSpectrogramBtn'),
                resizeImageBtn: document.getElementById('resizeImageBtn'),
                audioPlayer: document.getElementById('audioPlayer'),
                audioControls: document.getElementById('audioControls'),
                spectrogramContainer: document.getElementById('spectrogramContainer'),
                progressContainer: document.getElementById('progressContainer'),
                progressBar: document.getElementById('progressBar'),
                imageStatus: document.getElementById('imageStatus'),
                audioStatus: document.getElementById('audioStatus'),
                spectrogramStatus: document.getElementById('spectrogramStatus'),
                sliders: {
                    duration: document.getElementById('durationSlider'),
                    pitch: document.getElementById('pitchSlider'),
                    fftSize: document.getElementById('fftSizeSlider'),
                    brightness: document.getElementById('brightnessSlider'),
                    width: document.getElementById('widthSlider'),
                    height: document.getElementById('heightSlider')
                },
                values: {
                    duration: document.getElementById('durationValue'),
                    pitch: document.getElementById('pitchValue'),
                    fftSize: document.getElementById('fftSizeValue'),
                    brightness: document.getElementById('brightnessValue'),
                    width: document.getElementById('widthValue'),
                    height: document.getElementById('heightValue')
                },
                keepAspectCheckbox: document.getElementById('keepAspectCheckbox')
            },
            ctx: {
                image: document.getElementById('imageCanvas').getContext('2d'),
                spectrogram: document.getElementById('spectrogramCanvas').getContext('2d')
            },
            state: {
                originalImage: null,
                originalWidth: 0,
                originalHeight: 0,
                aspectRatio: 1
            }
        };

        // Настройка слайдеров
        setupSlider(imageSection.elements.sliders.fftSize, imageSection.elements.values.fftSize, 
                   v => Math.pow(2, parseInt(v)));
        setupSlider(imageSection.elements.sliders.duration, imageSection.elements.values.duration);
        setupSlider(imageSection.elements.sliders.pitch, imageSection.elements.values.pitch);
        setupSlider(imageSection.elements.sliders.brightness, imageSection.elements.values.brightness);
        setupSlider(imageSection.elements.sliders.width, imageSection.elements.values.width);
        setupSlider(imageSection.elements.sliders.height, imageSection.elements.values.height);

        // Обновление размеров с сохранением пропорций
        function updateDimensions() {
            if (imageSection.elements.keepAspectCheckbox.checked && 
                imageSection.state.originalWidth > 0 && 
                imageSection.state.originalHeight > 0) {
                
                if (this === imageSection.elements.sliders.width) {
                    const newWidth = parseInt(imageSection.elements.sliders.width.value);
                    const newHeight = Math.round(newWidth / imageSection.state.aspectRatio);
                    imageSection.elements.sliders.height.value = newHeight;
                    imageSection.elements.values.height.textContent = newHeight;
                } else {
                    const newHeight = parseInt(imageSection.elements.sliders.height.value);
                    const newWidth = Math.round(newHeight * imageSection.state.aspectRatio);
                    imageSection.elements.sliders.width.value = newWidth;
                    imageSection.elements.values.width.textContent = newWidth;
                }
            }

            imageSection.elements.values.width.textContent = imageSection.elements.sliders.width.value;
            imageSection.elements.values.height.textContent = imageSection.elements.sliders.height.value;
        }

        imageSection.elements.sliders.width.addEventListener('input', updateDimensions);
        imageSection.elements.sliders.height.addEventListener('input', updateDimensions);

        // Изменение размера изображения
        function resizeImage() {
            if (!imageSection.state.originalImage) return;

            const newWidth = parseInt(imageSection.elements.sliders.width.value);
            const newHeight = parseInt(imageSection.elements.sliders.height.value);

            imageSection.elements.imageCanvas.width = newWidth;
            imageSection.elements.imageCanvas.height = newHeight;
            imageSection.ctx.image.drawImage(
                imageSection.state.originalImage, 
                0, 0, 
                newWidth, newHeight
            );
            
            imageSection.elements.imageStatus.textContent = `Изображение изменено: ${newWidth}x${newHeight} пикселей`;
        }

        imageSection.elements.resizeImageBtn.addEventListener('click', resizeImage);

        // Загрузка изображения
        imageSection.elements.imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Сохраняем оригинальное изображение
                    imageSection.state.originalImage = img;
                    imageSection.state.originalWidth = img.width;
                    imageSection.state.originalHeight = img.height;
                    imageSection.state.aspectRatio = img.width / img.height;

                    // Устанавливаем начальные значения слайдеров
                    imageSection.elements.sliders.width.value = Math.min(img.width, 800);
                    imageSection.elements.sliders.height.value = Math.min(img.height, 400);
                    imageSection.elements.values.width.textContent = imageSection.elements.sliders.width.value;
                    imageSection.elements.values.height.textContent = imageSection.elements.sliders.height.value;

                    // Рисуем изображение с начальными размерами
                    resizeImage();
                    imageSection.elements.generateAudioBtn.disabled = false;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Показать/скрыть спектрограмму
        imageSection.elements.showSpectrogramBtn.addEventListener('click', function() {
            imageSection.elements.spectrogramContainer.style.display = 
                imageSection.elements.spectrogramContainer.style.display === 'none' ? 'block' : 'none';
        });

        // Генерация аудио из изображения
        imageSection.elements.generateAudioBtn.addEventListener('click', async function() {
            if (imageSection.elements.imageCanvas.width === 0) {
                imageSection.elements.audioStatus.textContent = "Сначала загрузите изображение";
                return;
            }

            imageSection.elements.audioStatus.textContent = "Создание аудио... (это может занять некоторое время)";
            imageSection.elements.generateAudioBtn.disabled = true;
            imageSection.elements.progressContainer.style.display = 'block';
            imageSection.elements.progressBar.style.width = '0%';
            imageSection.elements.progressBar.textContent = '0%';
            
            try {
                const duration = parseFloat(imageSection.elements.sliders.duration.value);
                const pitchFactor = parseFloat(imageSection.elements.sliders.pitch.value);
                const brightnessFactor = parseFloat(imageSection.elements.sliders.brightness.value);
                
                // Создаем аудио контекст
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const sampleRate = audioContext.sampleRate;
                const totalSamples = Math.floor(duration * sampleRate);
                
                // Получаем данные изображения
                const imageData = imageSection.ctx.image.getImageData(
                    0, 0, 
                    imageSection.elements.imageCanvas.width, 
                    imageSection.elements.imageCanvas.height
                );
                const pixels = imageData.data;
                
                // Создаем аудио буфер
                const audioBuffer = audioContext.createBuffer(1, totalSamples, sampleRate);
                const output = audioBuffer.getChannelData(0);
                
                // Преобразуем изображение в звук
                const columnWidth = imageSection.elements.imageCanvas.width / duration;
                const heightFactor = 1 / imageSection.elements.imageCanvas.height;
                
                // Разбиваем на части для обновления прогресса
                const chunkSize = Math.floor(totalSamples / 100);
                
                for (let i = 0; i < totalSamples; i++) {
                    const time = i / sampleRate;
                    const x = Math.floor(time * columnWidth * pitchFactor) % imageSection.elements.imageCanvas.width;
                    
                    let sampleValue = 0;
                    
                    // Суммируем вклады от всех строк изображения
                    for (let y = 0; y < imageSection.elements.imageCanvas.height; y++) {
                        const idx = (y * imageSection.elements.imageCanvas.width + x) * 4;
                        const r = pixels[idx];
                        const g = pixels[idx + 1];
                        const b = pixels[idx + 2];
                        const brightness = (r + g + b) / 765; // Нормализованная яркость 0-1
                        
                        // Частота зависит от положения строки (y)
                        const freq = (1 - y * heightFactor) * 4000 * pitchFactor;
                        
                        // Фаза зависит от времени и частоты
                        const phase = time * freq * 2 * Math.PI;
                        
                        // Амплитуда зависит от яркости
                        const amplitude = Math.pow(brightness, 2) * brightnessFactor;
                        
                        // Добавляем вклад этой строки
                        sampleValue += amplitude * Math.sin(phase);
                    }
                    
                    // Нормализуем и ограничиваем значение
                    output[i] = Math.max(-0.99, Math.min(0.99, sampleValue / imageSection.elements.imageCanvas.height * 2));
                    
                    // Обновляем прогресс
                    if (i % chunkSize === 0) {
                        const progress = Math.floor((i / totalSamples) * 100);
                        imageSection.elements.progressBar.style.width = `${progress}%`;
                        imageSection.elements.progressBar.textContent = `${progress}%`;
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
                
                imageSection.elements.progressBar.style.width = '100%';
                imageSection.elements.progressBar.textContent = '100%';
                
                // Создаем спектрограмму
                await createImageSpectrogram(audioBuffer, audioContext);
                
                // Сохраняем аудио для скачивания
                const audioBlob = await bufferToWave(audioBuffer, totalSamples);
                const audioUrl = URL.createObjectURL(audioBlob);
                imageSection.elements.audioPlayer.src = audioUrl;
                imageSection.elements.audioControls.style.display = 'block';
                
                imageSection.elements.audioStatus.textContent = "Аудио создано!";
                imageSection.elements.generateAudioBtn.disabled = false;
                imageSection.elements.progressContainer.style.display = 'none';
                
                // Функция для сохранения аудио
                imageSection.elements.saveAudioBtn.onclick = function() {
                    const a = document.createElement('a');
                    a.href = audioUrl;
                    a.download = 'image-sound.wav';
                    a.click();
                };
                
            } catch (error) {
                imageSection.elements.audioStatus.textContent = "Ошибка: " + error.message;
                console.error(error);
                imageSection.elements.generateAudioBtn.disabled = false;
                imageSection.elements.progressContainer.style.display = 'none';
            }
        });

        // Создание спектрограммы для изображения
        async function createImageSpectrogram(audioBuffer, audioContext) {
            imageSection.elements.spectrogramStatus.textContent = "Создание HD спектрограммы...";
            imageSection.elements.spectrogramContainer.style.display = 'none';
            
            const fftSize = Math.pow(2, parseInt(imageSection.elements.sliders.fftSize.value));
            const width = imageSection.elements.spectrogramCanvas.width = 1200;
            const height = imageSection.elements.spectrogramCanvas.height = 600;
            
            // Очищаем canvas
            imageSection.ctx.spectrogram.fillStyle = '#000011';
            imageSection.ctx.spectrogram.fillRect(0, 0, width, height);
            
            // Создаем анализер
            const analyser = audioContext.createAnalyser();
            analyser.fftSize = fftSize;
            analyser.smoothingTimeConstant = 0;
            
            // Создаем временный источник
            const bufferSource = audioContext.createBufferSource();
            bufferSource.buffer = audioBuffer;
            
            // Подготовка данных
            const frequencyData = new Uint8Array(analyser.frequencyBinCount);
            let currentX = 0;
            const columnWidth = width / (audioBuffer.duration * 20); // 20 колонок в секунду
            
            // Создаем цепочку обработки
            const scriptNode = audioContext.createScriptProcessor(fftSize, 1, 1);
            
            scriptNode.onaudioprocess = function() {
                if (currentX >= width) return;
                
                analyser.getByteFrequencyData(frequencyData);
                
                // Рисуем столбец спектрограммы
                for (let y = 0; y < height; y++) {
                    // Логарифмическое масштабирование частот
                    const freqIndex = Math.floor(
                        Math.pow(y / height, 1.5) * analyser.frequencyBinCount
                    );
                    
                    const value = frequencyData[Math.min(freqIndex, analyser.frequencyBinCount - 1)] / 255;
                    
                    // Улучшенная цветовая схема
                    let r, g, b;
                    if (value < 0.25) {
                        r = 0;
                        g = 0;
                        b = 50 + value * 4 * 205;
                    } else if (value < 0.5) {
                        r = (value - 0.25) * 4 * 255;
                        g = (value - 0.25) * 4 * 255;
                        b = 255;
                    } else if (value < 0.75) {
                        r = 255;
                        g = 255;
                        b = 255 - (value - 0.5) * 4 * 255;
                    } else {
                        r = 255;
                        g = 255 - (value - 0.75) * 4 * 155;
                        b = 0;
                    }
                    
                    // Добавляем немного яркости для лучшей видимости
                    const boost = 1.2;
                    r = Math.min(255, r * boost);
                    g = Math.min(255, g * boost);
                    b = Math.min(255, b * boost);
                    
                    imageSection.ctx.spectrogram.fillStyle = `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
                    imageSection.ctx.spectrogram.fillRect(currentX, height - y - 1, Math.ceil(columnWidth), 1);
                }
                
                currentX += columnWidth;
            };
            
            // Подключаем цепочку
            bufferSource.connect(analyser);
            analyser.connect(scriptNode);
            scriptNode.connect(audioContext.destination);
            
            // Сохранение спектрограммы
            imageSection.elements.saveSpectrogramBtn.onclick = function() {
                const link = document.createElement('a');
                link.download = 'hd-spectrogram.png';
                link.href = imageSection.elements.spectrogramCanvas.toDataURL('image/png');
                link.click();
            };
            
            // Запускаем воспроизведение
            bufferSource.start();
            
            // Обработка завершения
            return new Promise((resolve) => {
                bufferSource.onended = function() {
                    imageSection.elements.spectrogramStatus.textContent = `HD спектрограмма создана (${fftSize} точек FFT)`;
                    scriptNode.disconnect();
                    imageSection.elements.spectrogramContainer.style.display = 'block';
                    resolve();
                };
            });
        }

        // ===== Секция: Аудио → Спектрограмма =====
        const audioAnalysisSection = {
            elements: {
                audioInput: document.getElementById('audioFileInput'),
                audioPlayer: document.getElementById('audioFilePlayer'),
                spectrogramCanvas: document.getElementById('audioSpectrogramCanvas'),
                analyzeBtn: document.getElementById('analyzeAudioBtn'),
                saveBtn: document.getElementById('saveAudioSpectrogramBtn'),
                audioStatus: document.getElementById('audioFileStatus'),
                spectrogramStatus: document.getElementById('audioSpectrogramStatus'),
                progressContainer: document.getElementById('audioAnalysisProgress'),
                progressBar: document.getElementById('audioAnalysisBar')
            },
            ctx: {
                spectrogram: document.getElementById('audioSpectrogramCanvas').getContext('2d')
            }
        };

        // Загрузка аудиофайла
        audioAnalysisSection.elements.audioInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            audioAnalysisSection.elements.audioStatus.textContent = "Загрузка аудио...";
            audioAnalysisSection.elements.analyzeBtn.disabled = true;
            audioAnalysisSection.elements.saveBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = function(event) {
                audioAnalysisSection.elements.audioPlayer.src = event.target.result;
                audioAnalysisSection.elements.audioStatus.textContent = "Аудио загружено. Нажмите 'Анализировать аудио'";
                audioAnalysisSection.elements.analyzeBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        });

        // Анализ аудио и создание спектрограммы
        audioAnalysisSection.elements.analyzeBtn.addEventListener('click', async function() {
            if (!audioAnalysisSection.elements.audioPlayer.src) {
                audioAnalysisSection.elements.spectrogramStatus.textContent = "Сначала загрузите аудиофайл";
                return;
            }

            audioAnalysisSection.elements.spectrogramStatus.textContent = "Анализ аудио...";
            audioAnalysisSection.elements.analyzeBtn.disabled = true;
            audioAnalysisSection.elements.saveBtn.disabled = true;
            audioAnalysisSection.elements.progressContainer.style.display = 'block';
            audioAnalysisSection.elements.progressBar.style.width = '0%';
            
            try {
                // Создаем аудио контекст
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Загружаем аудио данные
                const response = await fetch(audioAnalysisSection.elements.audioPlayer.src);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // Параметры спектрограммы
                const duration = audioBuffer.duration;
                const sampleRate = audioBuffer.sampleRate;
                const fftSize = 4096; // Размер FFT для хорошей детализации
                const overlapFactor = 0.75; // Перекрытие между кадрами
                
                // Настройки отображения
                audioAnalysisSection.elements.spectrogramCanvas.width = Math.min(2000, Math.floor(duration * 100)); // 100 пикселей на секунду
                audioAnalysisSection.elements.spectrogramCanvas.height = 512;
                
                // Очищаем canvas
                audioAnalysisSection.ctx.spectrogram.fillStyle = 'black';
                audioAnalysisSection.ctx.spectrogram.fillRect(0, 0, 
                    audioAnalysisSection.elements.spectrogramCanvas.width, 
                    audioAnalysisSection.elements.spectrogramCanvas.height
                );
                
                // Создаем анализатор
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = fftSize;
                const bufferLength = analyser.frequencyBinCount;
                const frequencyData = new Uint8Array(bufferLength);
                
                // Создаем источник
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                
                // Подключаем анализатор
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                // Параметры для прогресса
                const totalSamples = audioBuffer.length;
                const samplesPerPixel = totalSamples / audioAnalysisSection.elements.spectrogramCanvas.width;
                let currentX = 0;
                
                // Функция обработки кадров
                const processFrame = () => {
                    if (currentX >= audioAnalysisSection.elements.spectrogramCanvas.width) {
                        source.stop();
                        audioAnalysisSection.elements.spectrogramStatus.textContent = "Анализ завершен!";
                        audioAnalysisSection.elements.analyzeBtn.disabled = false;
                        audioAnalysisSection.elements.saveBtn.disabled = false;
                        audioAnalysisSection.elements.progressBar.style.width = '100%';
                        return;
                    }
                    
                    // Получаем частотные данные
                    analyser.getByteFrequencyData(frequencyData);
                    
                    // Рисуем столбец спектрограммы
                    for (let y = 0; y < audioAnalysisSection.elements.spectrogramCanvas.height; y++) {
                        // Логарифмическое масштабирование частот (для лучшего отображения низких частот)
                        const freqIndex = Math.floor(
                            Math.pow(y / audioAnalysisSection.elements.spectrogramCanvas.height, 0.7) * bufferLength
                        );
                        
                        const value = frequencyData[freqIndex] / 255;
                        
                        // Цветовая схема (тепловая карта)
                        const hue = 240 - (value * 240); // От синего к красному
                        const saturation = 100;
                        const lightness = value * 50 + 20;
                        audioAnalysisSection.ctx.spectrogram.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                        audioAnalysisSection.ctx.spectrogram.fillRect(
                            currentX, 
                            audioAnalysisSection.elements.spectrogramCanvas.height - y - 1, 
                            1, 
                            1
                        );
                    }
                    
                    // Обновляем прогресс
                    currentX++;
                    audioAnalysisSection.elements.progressBar.style.width = 
                        `${(currentX / audioAnalysisSection.elements.spectrogramCanvas.width * 100)}%`;
                    
                    // Продолжаем обработку
                    requestAnimationFrame(processFrame);
                };
                
                // Запускаем анализ
                source.start();
                processFrame();
                
                // Сохранение спектрограммы
                audioAnalysisSection.elements.saveBtn.addEventListener('click', function() {
                    const link = document.createElement('a');
                    link.download = 'audio-spectrogram.png';
                    link.href = audioAnalysisSection.elements.spectrogramCanvas.toDataURL('image/png');
                    link.click();
                });
                
            } catch (error) {
                audioAnalysisSection.elements.spectrogramStatus.textContent = "Ошибка: " + error.message;
                console.error(error);
                audioAnalysisSection.elements.analyzeBtn.disabled = false;
                audioAnalysisSection.elements.progressContainer.style.display = 'none';
            }
        });

        // ===== Общие функции =====
        // Функция для преобразования аудио буфера в WAV файл
        async function bufferToWave(audioBuffer, len) {
            const numOfChan = 1;
            const length = len * numOfChan * 2 + 44;
            const buffer = new ArrayBuffer(length);
            const view = new DataView(buffer);
            let pos = 0;
            
            // Записываем WAV заголовок
            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // file length - 8
            setUint32(0x45564157); // "WAVE"
            
            setUint32(0x20746d66); // "fmt " chunk
            setUint32(16); // length = 16
            setUint16(1); // PCM (uncompressed)
            setUint16(numOfChan);
            setUint32(audioBuffer.sampleRate);
            setUint32(audioBuffer.sampleRate * 2 * numOfChan); // avg. bytes/sec
            setUint16(numOfChan * 2); // block-align
            setUint16(16); // 16-bit (hardcoded)
            
            setUint32(0x61746164); // "data" - chunk
            setUint32(length - pos - 4); // chunk length
            
            // Записываем PCM samples
            const chanData = audioBuffer.getChannelData(0);
            for (let i = 0; i < chanData.length; i++) {
                const sample = Math.max(-1, Math.min(1, chanData[i]));
                setUint16(sample * 32767);
            }
            
            // Вспомогательные функции
            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }
            
            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }
    </script>
</body>
</html>
